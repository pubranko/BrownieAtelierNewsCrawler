name: Brownie Atelier Deploy
run-name: Brownie Atelier Deploy!!!
on:
    # ‰ª•‰∏ã„ÅÆ„Éñ„É©„É≥„ÉÅ„Å´„Éó„ÉÉ„Ç∑„É•„Åï„Çå„ÅüÈöõËµ∑Âãï
    push:
        branches: ['develop','master']
    # Github„Çà„ÇäÊâãÂãï„ÅßËµ∑Âãï
    workflow_dispatch:

jobs:

  Branch-Controll:
    runs-on: ubuntu-22.04
    steps:
      - name: „Éñ„É©„É≥„ÉÅ„Çà„ÇäÁí∞Â¢É„ÇíÈÅ∏Êäû (ÁèæÂú®„ÅÆ„Éñ„É©„É≥„ÉÅÔºö ${{ github.ref }})
        id: branch_check
        run: |
          if [ "${{ github.ref }}" = "refs/heads/master" ]; then
            echo "env_name=PRODUCT" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            echo "env_name=TEST" >> $GITHUB_OUTPUT
          else
            echo "env_name=TEST" >> $GITHUB_OUTPUT
          fi         
          
      - run: echo "Áí∞Â¢ÉÂêçÔºö ${{ steps.branch_check.outputs.env_name }}"
        
    outputs:
      env_name: ${{ steps.branch_check.outputs.env_name }}

  Brownie-Atelier-Deploy:
    needs: [Branch-Controll]
    runs-on: ubuntu-22.04
    environment:
      name: ${{ needs.Branch-Controll.outputs.env_name }}
    env:
        ## mongoDBÁî®„Ç≥„É≥„ÉÜ„Éä„Éº„ÅßÂèÇÁÖß„Åô„Çã„Ç§„É°„Éº„Ç∏„ÅÆ„Çø„Ç∞
        MONGO_TAG: 7.0.1-jammy
        ## dockerfile_base„ÅßÂèÇÁÖß„Åô„Çãubuntu„Ç§„É°„Éº„Ç∏„ÅÆ„Çø„Ç∞
        UBUNTU_TAG: 22.04
        ## dockerfile„ÅßÂèÇÁÖß„Åô„Çãbase„Ç§„É°„Éº„Ç∏„ÅÆ„Çø„Ç∞
        BASE_TAG: ${{ vars.BASE_TAG }}
        # docker-compose„ÅßÂèÇÁÖß„Åô„Çãnew_crawler„Ç§„É°„Éº„Ç∏„ÅÆ„Çø„Ç∞
        # NEWS_CRAWLER_TAG: test-0.15
        # „Ç≥„É≥„ÉÜ„Éä„ÉºÂÜÖroot„É¶„Éº„Ç∂„Éº„Éë„Çπ„ÉØ„Éº„Éâ
        CONTAINER_ROOT_USER: root_user
        CONTAINER_ROOT_PASS: password
        # „Ç≥„É≥„ÉÜ„ÉäÂÜÖ„ÅÆ‰∏ÄËà¨„É¶„Éº„Ç∂„Éº„ÄÅ„Éë„Çπ„ÉØ„Éº„Éâ
        CONTAINER_USER: common_user
        CONTAINER_USER_PASS: password
        # „Éñ„É©„Ç¶„Éã„ÉºÂ∑•Êàø„ÅÆgit„É™„É¢„Éº„Éà„É™„Éù„Ç∏„Éà„É™„Éº
        GIT_REMOTE_REPOSITORY: https://github.com/pubranko/BrownieAtelierNewsCrawler.git
        # ‰∏äË®ò„É™„Éù„Ç∏„Éà„É™„Éº„ÅÆgit„Éñ„É©„É≥„ÉÅ
        GIT_BRANCH: ${{github.ref_name}}
        # Firefox „ÅÆ gecko driver
        GECKO_DRIVER: https://github.com/mozilla/geckodriver/releases/download/v0.33.0/geckodriver-v0.33.0-linux64.tar.gz

        # „Éõ„Çπ„ÉàÔºà„É≠„Éº„Ç´„É´ÔºâÂÅ¥„ÅÆmongoDBÊé•Á∂öÁî®„ÅÆcrt„ÇÑpem„Éï„Ç°„Ç§„É´„ÅÆ‰øùÁÆ°„Éá„Ç£„É¨„ÇØ„Éà„É™
        LOCAL_MONGO_KEY_DIR: /tmp

        # mongoDB„Ç≥„É≥„ÉÜ„Éä„Éº‰∏ÄËà¨„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÄÅmongoDBÊé•Á∂öÊÉÖÂ†±
        BROWNIE_ATELIER_MONGO__MONGO_SERVER: mongo-server
        BROWNIE_ATELIER_MONGO__MONGO_PORT: 27017
        BROWNIE_ATELIER_MONGO__MONGO_USE_DB: test_crawler_db
        BROWNIE_ATELIER_MONGO__MONGO_USER: mongo_user
        BROWNIE_ATELIER_MONGO__MONGO_PASS: mongo_pass
        BROWNIE_ATELIER_MONGO__MONGO_TLS: false
        BROWNIE_ATELIER_MONGO__MONGO_TLS_CA_FILE:
        BROWNIE_ATELIER_MONGO__MONGO_TLS_CERTTIFICATE_KEY_FILE:
        # Brownie atelier notice„ÅÆË®≠ÂÆö (slack)
        BROWNIE_ATELIER_NOTICE__SLACK_TOKEN: ${{ secrets.BROWNIE_ATELIER_NOTICE__SLACK_TOKEN}}
        BROWNIE_ATELIER_NOTICE__SLACK_CHANNEL_ID__ERROR: ${{ secrets.BROWNIE_ATELIER_NOTICE__SLACK_CHANNEL_ID__ERROR}}
        BROWNIE_ATELIER_NOTICE__SLACK_CHANNEL_ID__NOMAL: ${{ secrets.BROWNIE_ATELIER_NOTICE__SLACK_CHANNEL_ID__NOMAL}}
        # 
        HOST_OS_IP_ADDRESS: 192.0.0.1
        # Prefect
        # PREFECT_HOME: ${{ github.workspace }} # /home/runner/work/BrownieAtelierNewsCrawler/BrownieAtelierNewsCrawler
        PREFECT_HOME: ${{ github.workspace }}
        # PREFECT_API_URL: ${{ secrets.PREFECT_API_URL }}
        # PREFECT__API_KEY: ${{ secrets.PREFECT__API_KEY }} # prefect cloud„Å®Êé•Á∂ö„Åô„ÇãÂ†¥Âêà„ÅÆ„ÅøÂøÖË¶Å
        # PREFECT__WORK_SPACE: ${{ secrets.PREFECT__WORK_SPACE }}
        # PREFECT__WORK_POOL: ${{ secrets.PREFECT__WORK_POOL }}
        PREFECT__DATA:
        SCRAPY__LOG_LEVEL:
        # Docker „Ç§„É°„Éº„Ç∏„ÅÆ tar „Ç¢„Éº„Ç´„Ç§„ÉñÂá∫ÂäõÂÖà„ÅÆ„Éë„Çπ
        PATH_CACHE: /tmp/docker-img-arch
    steps:
      - run: echo "üéâ Ëµ∑Âãï„Ç§„Éô„É≥„Éà„ÅÆÁ®ÆÈ°û (${{ github.event_name }})"
      - run: echo "üêß github‰∏ä„ÅÆOS„ÅÆÁ®ÆÈ°û (${{ runner.os }})"
      - name: „É™„Éù„Ç∏„Éà„É™(${{ github.repository }})„Éª„Éñ„É©„É≥„ÉÅ(${{ github.ref }})„Å´„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
        # ‰∏äË®ò„ÅÆ„É™„Éù„Ç∏„Éà„É™„Éª„Éñ„É©„É≥„ÉÅ„Å´„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
        uses: actions/checkout@v4

      - name: „ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„ÉÅ„Çß„ÉÉ„ÇØ
        # „ÉÜ„Çπ„ÉàÂâç„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÁ¢∫Ë™ç
        # „ÇØ„É≠„Éº„É≥Âæå„ÅØ„Åì„Åì„Å´„ÇΩ„Éº„Çπ„ÅåÊ†ºÁ¥ç„Åï„Çå„Çã /home/runner/work/BrownieAtelierNewsCrawler/BrownieAtelierNewsCrawler
        run: |
          ls -a ${{ github.workspace }}

      #################################################
      # base„Ç§„É°„Éº„Ç∏„Ç≥„É≥„ÉÜ„Éä„Éº
      #################################################

      - name: base„Ç§„É°„Éº„Ç∏Áî®„Ç≠„É£„ÉÉ„Ç∑„É•„ÅÆÂÆöÁæ© & Âæ©ÂÖÉ
        # „Ç≠„É£„ÉÉ„Ç∑„É•ID „ÅÆÂÆöÁæ©
        id: base_image_cache
        uses: actions/cache@v4
        with:
          path: ${{ env.PATH_CACHE }}
          key: ${{ runner.os }}-brownie-atelier-news-crawler-base-${{ env.BASE_TAG }}

      # „Ç≠„É£„ÉÉ„Ç∑„É•„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ tar „Çídocker„Å´„É≠„Éº„Éâ„Åó„Å¶„Ç§„É°„Éº„Ç∏„Å´ËøΩÂä†
      - name: baseÁî®„Ç≠„É£„ÉÉ„Ç∑„É•„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ tar „Çí„É≠„Éº„Éâ„Åó„Å¶„Ç§„É°„Éº„Ç∏‰∏ÄË¶ß„Å´ËøΩÂä†
        if: steps.base_image_cache.outputs.cache-hit == 'true'
        run: |
          ls -l ${{ env.PATH_CACHE }}
          docker load --input ${{ env.PATH_CACHE }}/${{ runner.os }}-brownie-atelier-news-crawler-base-${{ env.BASE_TAG }}.tar
          docker images

      - name: base„Ç§„É°„Éº„Ç∏„Åå„Ç≠„É£„ÉÉ„Ç∑„É•„Å´„Å™„ÅÑÂ†¥Âêà„Å´build„Å®save(„Ç≠„É£„ÉÉ„Ç∑„É•)„ÇíÂÆüË°å
        if: steps.base_image_cache.outputs.cache-hit != 'true'
        # git branch„Å´„ÅØdevelop„ÇíÂõ∫ÂÆö„ÅßÂâ≤„ÇäÂΩì„Å¶„Å®„Åô„Çã„ÄÇ new_crawler„Ç§„É°„Éº„Ç∏‰ΩúÊàêÂÅ¥„Åß‰øÆÊ≠£‰∏≠„ÅÆ„Éñ„É©„É≥„ÉÅ„ÇÑmasterÁ≠â„ÇíÈÅ©Áî®„Åô„ÇãÈÅãÁî®„Å®„Åô„Çã„ÄÇ 
        run: |
          mkdir ${{ env.PATH_CACHE }}
          export GIT_BRANCH=develop
          docker compose -f docker-compose__base-image-build.yml build
          docker save brownie-atelier-news-crawler-base:${{ env.BASE_TAG }} -o ${{ env.PATH_CACHE }}/${{ runner.os }}-brownie-atelier-news-crawler-base-${{ env.BASE_TAG }}.tar
          ls -l ${{ env.PATH_CACHE }}
          docker images

      #################################################
      # new_crawler„Ç§„É°„Éº„Ç∏„Ç≥„É≥„ÉÜ„Éä„Éº
      #################################################
      - name: new_crawler„Ç§„É°„Éº„Ç∏„Çø„Ç∞Êé°Áï™
        run: |
          export DOCKER_HUB_USERNAME=${{ secrets.DOCKER_HUB_USERNAME }}
          echo "NEWS_CRAWLER_TAG=$(python app/scripts/tag_create.py --mode ${{ needs.Branch-Controll.outputs.env_name }})" >> $GITHUB_ENV

      - name: new_crawler„Ç§„É°„Éº„Ç∏build
        # new_crawler„Ç§„É°„Éº„Ç∏‰ΩúÊàê
        run: |
          export NEWS_CRAWLER_TAG=${{ env.NEWS_CRAWLER_TAG }}
          export DOCKER_HUB_USERNAME=${{ secrets.DOCKER_HUB_USERNAME }}
          docker compose -f docker-compose__news-crawler-image-build.yml build
          docker tag brownie-atelier-news-crawler:${{ env.NEWS_CRAWLER_TAG }} ${{ secrets.DOCKER_HUB_USERNAME }}/brownie-atelier-news-crawler:${{ env.NEWS_CRAWLER_TAG }}
          docker images

      #################################################
      # new_crawler„Ç§„É°„Éº„Ç∏„Çídocker hub„Å∏push
      #################################################

      # dockerhub„Å´„É≠„Ç∞„Ç§„É≥
      - name: dockerhub„Å´„É≠„Ç∞„Ç§„É≥
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      # dockerhub„Å∏push
      - name: push - dockerhub
        run: |
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/brownie-atelier-news-crawler:${{ env.NEWS_CRAWLER_TAG}}
