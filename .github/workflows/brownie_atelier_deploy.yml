name: Brownie Atelier Deploy
run-name: Brownie Atelier Deploy!!!
on:
    # ä»¥ä¸‹ã®ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸéš›èµ·å‹•
    push:
        # branches: ['develop','master']
        branches: ['develop']
    # Githubã‚ˆã‚Šæ‰‹å‹•ã§èµ·å‹•
    workflow_dispatch:

jobs:

  Branch-Controll:
    runs-on: ubuntu-22.04
    steps:
      - name: ãƒ–ãƒ©ãƒ³ãƒã‚ˆã‚Šç’°å¢ƒã‚’é¸æŠ (ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒï¼š ${{ github.ref }})
        id: branch_check
        run: |
          if [ "${{ github.ref }}" = "refs/heads/master" ]; then
            echo "env_name=PRODUCT" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            echo "env_name=TEST" >> $GITHUB_OUTPUT
          else
            echo "env_name=TEST" >> $GITHUB_OUTPUT
          fi         
          
      - run: echo "ç’°å¢ƒåï¼š ${{ steps.branch_check.outputs.env_name }}"
        
    outputs:
      env_name: ${{ steps.branch_check.outputs.env_name }}

  Brownie-Atelier-Deploy:
    needs: [Branch-Controll]
    runs-on: ubuntu-22.04
    environment:
      name: ${{ needs.Branch-Controll.outputs.env_name }}
    env:
        ## mongoDBç”¨ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã§å‚ç…§ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°
        MONGO_TAG: 7.0.1-jammy
        ## dockerfile_baseã§å‚ç…§ã™ã‚‹ubuntuã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°
        UBUNTU_TAG: 22.04
        ## # dockerfile_appã§å‚ç…§ã™ã‚‹baseã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°
        # BASE_TAG: test-0.15
        # docker-composeã§å‚ç…§ã™ã‚‹appã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°
        # APP_TAG: test-0.15
        # ã‚³ãƒ³ãƒ†ãƒŠãƒ¼å†…rootãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
        CONTAINER_ROOT_USER: root_user
        CONTAINER_ROOT_PASS: password
        # ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
        CONTAINER_USER: common_user
        CONTAINER_USER_PASS: password
        # ãƒ–ãƒ©ã‚¦ãƒ‹ãƒ¼å·¥æˆ¿ã®gitãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªãƒ¼
        GIT_REMOTE_REPOSITORY: https://github.com/pubranko/BrownieAtelier.git
        # ä¸Šè¨˜ãƒªãƒã‚¸ãƒˆãƒªãƒ¼ã®gitãƒ–ãƒ©ãƒ³ãƒ
        GIT_BRANCH: github-actions-test
        # Firefox ã® gecko driver
        GECKO_DRIVER: https://github.com/mozilla/geckodriver/releases/download/v0.33.0/geckodriver-v0.33.0-linux64.tar.gz

        # ãƒ›ã‚¹ãƒˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰å´ã®mongoDBæ¥ç¶šç”¨ã®crtã‚„pemãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿ç®¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
        LOCAL_MONGO_KEY_DIR: /tmp

        # docker-compose commandé¸æŠ
        CONTAINER_START_COMMAND: /home/common_user/BrownieAtelier/sh/prefect_cloud_deploy.sh

        # mongoDBã‚³ãƒ³ãƒ†ãƒŠãƒ¼ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã€mongoDBæ¥ç¶šæƒ…å ±
        BROWNIE_ATELIER_MONGO__MONGO_SERVER: mongo-server
        BROWNIE_ATELIER_MONGO__MONGO_PORT: 27017
        BROWNIE_ATELIER_MONGO__MONGO_USE_DB: test_crawler_db
        BROWNIE_ATELIER_MONGO__MONGO_USER: mongo_user
        BROWNIE_ATELIER_MONGO__MONGO_PASS: mongo_pass
        BROWNIE_ATELIER_MONGO__MONGO_TLS: false
        BROWNIE_ATELIER_MONGO__MONGO_TLS_CA_FILE:
        BROWNIE_ATELIER_MONGO__MONGO_TLS_CERTTIFICATE_KEY_FILE:
        # Emailæ¥ç¶šæƒ…å ±
        BROWNIE_ATELIER_NOTICE__SMTP_HOST: ${{ secrets.BROWNIE_ATELIER_NOTICE__SMTP_HOST }}
        BROWNIE_ATELIER_NOTICE__SMTP_PORT: ${{ secrets.BROWNIE_ATELIER_NOTICE__SMTP_PORT }}
        BROWNIE_ATELIER_NOTICE__FROM_EMAIL: ${{ secrets.BROWNIE_ATELIER_NOTICE__FROM_EMAIL }}
        BROWNIE_ATELIER_NOTICE__TO_EMAIL: ${{ secrets.BROWNIE_ATELIER_NOTICE__TO_EMAIL }}
        BROWNIE_ATELIER_NOTICE__PASSWORD: ${{ secrets.BROWNIE_ATELIER_NOTICE__PASSWORD }}
        # 
        HOST_OS_IP_ADDRESS: 192.0.0.1
        # Prefect
        # PREFECT_HOME: ${{ github.workspace }} # /home/runner/work/BrownieAtelier/BrownieAtelier
        PREFECT_HOME: ${{ github.workspace }}
        PREFECT_API_URL: ${{ secrets.PREFECT_API_URL }}
        PREFECT__API_KEY: ${{ secrets.PREFECT__API_KEY }}
        PREFECT__WORK_SPACE: ${{ secrets.PREFECT__WORK_SPACE }}
        PREFECT__WORK_POOL: ${{ secrets.PREFECT__WORK_POOL }}
        PREFECT__DATA:
        SCRAPY__LOG_LEVEL:
        # Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã® tar ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‡ºåŠ›å…ˆã®ãƒ‘ã‚¹
        PATH_CACHE: /tmp/docker-img-arch
    steps:
      - run: echo "ğŸ‰ èµ·å‹•ã‚¤ãƒ™ãƒ³ãƒˆã®ç¨®é¡ (${{ github.event_name }})"
      - run: echo "ğŸ§ githubä¸Šã®OSã®ç¨®é¡ (${{ runner.os }})"
      - name: ãƒªãƒã‚¸ãƒˆãƒª(${{ github.repository }})ãƒ»ãƒ–ãƒ©ãƒ³ãƒ(${{ github.ref }})ã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        # ä¸Šè¨˜ã®ãƒªãƒã‚¸ãƒˆãƒªãƒ»ãƒ–ãƒ©ãƒ³ãƒã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒã‚§ãƒƒã‚¯
        # ãƒ†ã‚¹ãƒˆå‰ãƒã‚§ãƒƒã‚¯ã‚’ç¢ºèª
        # ã‚¯ãƒ­ãƒ¼ãƒ³å¾Œã¯ã“ã“ã«ã‚½ãƒ¼ã‚¹ãŒæ ¼ç´ã•ã‚Œã‚‹ /home/runner/work/BrownieAtelier/BrownieAtelier
        run: |
          ls -a ${{ github.workspace }}

      #################################################
      # baseã‚¤ãƒ¡ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠãƒ¼
      #################################################

      - name: baseã‚¤ãƒ¡ãƒ¼ã‚¸ç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å®šç¾© & å¾©å…ƒ
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ID ã®å®šç¾©
        id: base_image_cache
        uses: actions/cache@v4
        with:
          path: ${{ env.PATH_CACHE }}
          key: ${{ runner.os }}-brownie_atelier_base-${{ vars.BASE_TAG }}

      # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚‹å ´åˆã¯ tar ã‚’dockerã«ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸ã«è¿½åŠ 
      - name: baseç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚‹å ´åˆã¯ tar ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸ä¸€è¦§ã«è¿½åŠ 
        if: steps.base_image_cache.outputs.cache-hit == 'true'
        run: |
          ls -l ${{ env.PATH_CACHE }}
          docker load --input ${{ env.PATH_CACHE }}/${{ runner.os }}-brownie_atelier_base-${{ vars.BASE_TAG }}.tar
          docker images

      - name: baseã‚¤ãƒ¡ãƒ¼ã‚¸ãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãªã„å ´åˆã«buildã¨save(ã‚­ãƒ£ãƒƒã‚·ãƒ¥)ã‚’å®Ÿè¡Œ
        if: steps.base_image_cache.outputs.cache-hit != 'true'
        # git branchã«ã¯developã‚’å›ºå®šã§å‰²ã‚Šå½“ã¦ã¨ã™ã‚‹ã€‚ appã‚¤ãƒ¡ãƒ¼ã‚¸ä½œæˆå´ã§ä¿®æ­£ä¸­ã®ãƒ–ãƒ©ãƒ³ãƒã‚„masterç­‰ã‚’é©ç”¨ã™ã‚‹é‹ç”¨ã¨ã™ã‚‹ã€‚ 
        run: |
          mkdir ${{ env.PATH_CACHE }}
          export GIT_BRANCH=develop
          export BASE_TAG=${{ vars.BASE_TAG }}
          docker-compose -f docker-compose__base-image-build.yml build
          docker save brownie_atelier_base:${{ vars.BASE_TAG }} -o ${{ env.PATH_CACHE }}/${{ runner.os }}-brownie_atelier_base-${{ vars.BASE_TAG }}.tar
          ls -l ${{ env.PATH_CACHE }}
          docker images

      #################################################
      # appã‚¤ãƒ¡ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠãƒ¼
      #################################################
      - name: appã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°æ¡ç•ª
        run: |
          export BASE_TAG=${{ vars.BASE_TAG }}
          export DOCKER_HUB_USERNAME=${{ secrets.DOCKER_HUB_USERNAME }}
          echo "APP_TAG=$(python app/scripts/tag_create.py --mode ${{ needs.Branch-Controll.outputs.env_name }})" >> $GITHUB_ENV

      - name: appã‚¤ãƒ¡ãƒ¼ã‚¸build
        # appã‚¤ãƒ¡ãƒ¼ã‚¸ä½œæˆ
        run: |
          export BASE_TAG=${{ vars.BASE_TAG }}
          export APP_TAG=${{ env.APP_TAG }}
          export DOCKER_HUB_USERNAME=${{ secrets.DOCKER_HUB_USERNAME }}
          docker-compose -f docker-compose__app-image-build.yml build
          docker tag brownie_atelier_app:${{ env.APP_TAG }} ${{ secrets.DOCKER_HUB_USERNAME }}/brownie_atelier_app:${{ env.APP_TAG }}
          docker images

      #################################################
      # appã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’docker hubã¸push
      #################################################

      # dockerhubã«ãƒ­ã‚°ã‚¤ãƒ³
      - name: dockerhubã«ãƒ­ã‚°ã‚¤ãƒ³
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      # dockerhubã¸push
      - name: push - dockerhub
        run: |
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/brownie_atelier_app:${{ env.APP_TAG}}

      ########################################################################
      # brownie_atelier_appèµ·å‹•æ™‚ã«dockerãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒå¿…è¦ã§ã‚ã‚‹ãŸã‚ä¾¿å®œä¸Šä½œæˆ
      ########################################################################
      - name: brownie_atelier_appèµ·å‹•ç”¨ã«dockerãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ä½œæˆ
        run: docker network create brownie-atelier-net
  
      #################################################
      # prefect flowã‚’prefectã‚¯ãƒ©ã‚¦ãƒ‰ã¸ãƒ‡ãƒ—ãƒ­ã‚¤
      #################################################

      - name: "Prefect Flowã‚’Prefectã‚¯ãƒ©ã‚¦ãƒ‰ã¸ãƒ‡ãƒ—ãƒ­ã‚¤"
        env:
          TZ: ${{ vars.TZ}}
        # å„ç¨®ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ
        run: |
          export PREFECT_RUN_SCRIPT="prefect_lib/deployments/all.py"
          docker-compose -f docker-compose__app-container.yml up
