name: GitHub Actions Demo
run-name: ${{ github.actor }} is testing out GitHub Actions ğŸš€
on: 
    # ä»¥ä¸‹ã®ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸéš›èµ·å‹•
    push:
        branches: ["github-actions-test"]
    # Githubã‚ˆã‚Šæ‰‹å‹•ã§èµ·å‹•
    workflow_dispatch:

# env:
#     AAA: bbb

jobs:
  GitHub-Actions-Test:
    runs-on: ubuntu-22.04
    environment:
      # name: ${{ github.ref }}
      name: TEST
    env:
        ## mongoDBç”¨ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã§å‚ç…§ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°
        MONGO_TAG: 7.0.1-jammy
        ## dockerfile_baseã§å‚ç…§ã™ã‚‹ubuntuã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°
        UBUNTU_TAG: 22.04
        ## # dockerfile_appã§å‚ç…§ã™ã‚‹baseã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°
        BASE_TAG: test-0.15
        # docker-composeã§å‚ç…§ã™ã‚‹appã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°
        APP_TAG: test-0.15
        # ã‚³ãƒ³ãƒ†ãƒŠãƒ¼å†…rootãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
        CONTAINER_ROOT_USER: root_user
        CONTAINER_ROOT_PASS: password
        # ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
        CONTAINER_USER: common_user
        CONTAINER_USER_PASS: password
        # ãƒ–ãƒ©ã‚¦ãƒ‹ãƒ¼å·¥æˆ¿ã®gitãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªãƒ¼
        GIT_REMOTE_REPOSITORY: https://github.com/pubranko/BrownieAtelier.git
        # ä¸Šè¨˜ãƒªãƒã‚¸ãƒˆãƒªãƒ¼ã®gitãƒ–ãƒ©ãƒ³ãƒ
        GIT_BRANCH: github-actions-test
        # Firefox ã® gecko driver
        GECKO_DRIVER: https://github.com/mozilla/geckodriver/releases/download/v0.33.0/geckodriver-v0.33.0-linux64.tar.gz

        # ãƒ›ã‚¹ãƒˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰å´ã®mongoDBæ¥ç¶šç”¨ã®crtã‚„pemãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿ç®¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
        LOCAL_MONGO_KEY_DIR: /tmp

        # docker-compose commandé¸æŠ
        # CONTAINER_START_COMMAND: 'bash -c "sleep 1000000000"'
        CONTAINER_START_COMMAND: 'bash -c "sleep 5"'

        # mongoDBã‚³ãƒ³ãƒ†ãƒŠãƒ¼ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã€mongoDBæ¥ç¶šæƒ…å ±
        BROWNIE_ATELIER_MONGO__MONGO_SERVER: mongo
        BROWNIE_ATELIER_MONGO__MONGO_PORT: 27017
        BROWNIE_ATELIER_MONGO__MONGO_USE_DB: test_crawler_db
        BROWNIE_ATELIER_MONGO__MONGO_USER: mongo_user
        BROWNIE_ATELIER_MONGO__MONGO_PASS: mongo_pass
        BROWNIE_ATELIER_MONGO__MONGO_TLS: false
        BROWNIE_ATELIER_MONGO__MONGO_TLS_CA_FILE: 
        BROWNIE_ATELIER_MONGO__MONGO_TLS_CERTTIFICATE_KEY_FILE: 
        # mongoDBã‚³ãƒ³ãƒ†ãƒŠãƒ¼rootæƒ…å ±
        BROWNIE_ATELIER_MONGO__MONGO_INITDB_ROOT_USERNAME: root_user
        BROWNIE_ATELIER_MONGO__MONGO_INITDB_ROOT_PASSWORD: password
        # Emailæ¥ç¶šæƒ…å ±
        BROWNIE_ATELIER_NOTICE__SMTP_HOST: ${{ secrets.BROWNIE_ATELIER_NOTICE__SMTP_HOST }}
        BROWNIE_ATELIER_NOTICE__SMTP_PORT: ${{ secrets.BROWNIE_ATELIER_NOTICE__SMTP_PORT }}
        BROWNIE_ATELIER_NOTICE__FROM_EMAIL: ${{ secrets.BROWNIE_ATELIER_NOTICE__FROM_EMAIL }}
        BROWNIE_ATELIER_NOTICE__TO_EMAIL: ${{ secrets.BROWNIE_ATELIER_NOTICE__TO_EMAIL }}
        BROWNIE_ATELIER_NOTICE__PASSWORD: ${{ secrets.BROWNIE_ATELIER_NOTICE__PASSWORD }}

        # HOST OS(WSL2)ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹(ã‚³ãƒ³ãƒ†ãƒŠãƒ¼å†…ã‹ã‚‰å‚ç…§)
        HOST_OS_IP_ADDRESS: mongo-container


    steps:
        # "ğŸ‰ ã‚¸ãƒ§ãƒ–ã¯ãƒ—ãƒƒã‚·ãƒ¥ ã‚¤ãƒ™ãƒ³ãƒˆã«ã‚ˆã£ã¦è‡ªå‹•çš„ã«ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã¾ã—ãŸã€‚" 
      - run: echo "ğŸ‰ èµ·å‹•ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã®ç¨®é¡ï¼š ${{ github.event_name }}"
        # ã€ŒğŸ§ ã“ã®ã‚¸ãƒ§ãƒ–ã¯ç¾åœ¨ã€GitHub ã«ã‚ˆã£ã¦ãƒ›ã‚¹ãƒˆã•ã‚Œã¦ã„ã‚‹ Linux ã‚µãƒ¼ãƒãƒ¼ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™!ã€
      - run: echo "ğŸ§ githubä¸Šã®OSã®ç¨®é¡ï¼š ${{ runner.os }}"
        # "ğŸ” ãƒ–ãƒ©ãƒ³ãƒã®åå‰ã¯ refs/heads/github-actions-testã€ãƒªãƒã‚¸ãƒˆãƒªã¯ pubranko/BrownieAtelier ã§ã™ã€‚" ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
      - run: echo "ğŸ” ãƒªãƒã‚¸ãƒˆãƒªåï¼š ${{ github.repository }}."
      - run: echo "ğŸ” ãƒ–ãƒ©ãƒ³ãƒåï¼š ${{ github.ref }}"
        # ä¸Šè¨˜ã®ãƒªãƒã‚¸ãƒˆãƒªãƒ»ãƒ–ãƒ©ãƒ³ãƒã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ä¸Šè¨˜ãƒªãƒã‚¸ãƒˆãƒªãƒ»ãƒ–ãƒ©ãƒ³ãƒã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

        # ğŸ–¥ï¸ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ãƒ©ãƒ³ãƒŠãƒ¼ã§ã‚³ãƒ¼ãƒ‰ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹æº–å‚™ãŒã§ãã¾ã—ãŸã€‚ã€
      - run: echo "ğŸ–¥ï¸ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ãƒ©ãƒ³ãƒŠãƒ¼ã§ã‚³ãƒ¼ãƒ‰ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹æº–å‚™ãŒã§ãã¾ã—ãŸã€‚"
        # 
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã§æ ¼ç´ã—ãŸçµæœã‚’ç¢ºèª
        # ã‚¯ãƒ­ãƒ¼ãƒ³å¾Œã¯ã“ã“ã«ã‚½ãƒ¼ã‚¹ãŒæ ¼ç´ã•ã‚Œã‚‹ /home/runner/work/BrownieAtelier/BrownieAtelier
        run: |
          ls -a ${{ github.workspace }}
        # "ğŸ This job's status is success."
      - run: echo "ğŸ å®Ÿè¡Œå¾Œã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼š ${{ job.status }}."

      # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã®ä¸€è¦§ã‚’èª¿ã¹ã¦ã¿ãŸã€‚
      #- run: sudo apt list --installed
      #- run: sudo dpkg-query -l

      # dockerãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ä½œæˆ
      - run: docker network create brownie-atelier-net

      # mongoDBã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã®ä½œæˆã€‚
      #   rootãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ä½¿ç”¨DBåã‚’æŒ‡å®šã€‚
      #   ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’create-user.jsã§ä½œæˆã€‚
      - name: Start MongoDB
        run:  >
          docker run -d
          --name mongo-container
          -p 27017:27017
          --network brownie-atelier-net
          -v $PWD/mongodb/init/create-user.js:/docker-entrypoint-initdb.d/create-user.js
          -e MONGO_INITDB_ROOT_USERNAME=${BROWNIE_ATELIER_MONGO__MONGO_INITDB_ROOT_USERNAME}
          -e MONGO_INITDB_ROOT_PASSWORD=${BROWNIE_ATELIER_MONGO__MONGO_INITDB_ROOT_PASSWORD}
          -e BROWNIE_ATELIER_MONGO__MONGO_USE_DB=${BROWNIE_ATELIER_MONGO__MONGO_USE_DB}
          -e BROWNIE_ATELIER_MONGO__MONGO_USER=${BROWNIE_ATELIER_MONGO__MONGO_USER}
          -e BROWNIE_ATELIER_MONGO__MONGO_PASS=${BROWNIE_ATELIER_MONGO__MONGO_PASS}
          mongo:${MONGO_TAG}

      - run: docker ps -a

      # baseã‚¤ãƒ¡ãƒ¼ã‚¸ä½œæˆ
      - run: docker-compose -f docker-compose__base-image-build.yml build

      # appã‚¤ãƒ¡ãƒ¼ã‚¸ä½œæˆ
      - run: docker-compose -f docker-compose__app-image-build.yml build
      
      # - run: docker stop mongo-container

      # ã‚³ãƒ³ãƒ†ãƒŠãƒ¼èµ·å‹•
      # ãŸã ã—å„Flowã‚’bashã§å®Ÿè¡Œã™ã‚‹ãŸã‚ã«commandã¯å·¥å¤«ã™ã‚‹ã€‚
      - run: docker-compose -f docker-compose__app-container.yml up -d

      - run: sleep 10

      - run: docker ps -a



      # å„ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚µã‚¤ãƒˆåˆ¥ã«ã€ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã®æƒ…å ±ã‚’ç™»éŒ²ã™ã‚‹ã€‚
      #   scraper_info_uploader_flow.py

      # å®šæœŸè¦³æ¸¬ç”¨ã®ã‚¹ãƒ‘ã‚¤ãƒ€ãƒ¼ã‚’ç™»éŒ²ã™ã‚‹ã€‚
      #   regular_observation_controller_update_flow.py
      #   ï¼“ã¤ã‚’æŒ‡å®šï¼ˆa:ç”£çµŒ,b:æœæ—¥,c:èª­å£²ï¼‰

      # åˆå›å®šæœŸè¦³æ¸¬
      #   first_observation_flow.py
      #   ä¸Šè¨˜ã®a,b,cã ã‘ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¯ãš

      # æ‰‹å‹•ã‚¯ãƒ­ãƒ¼ãƒªãƒ³ã‚°
      #   manual_crawling_flow.py
      #   ãã®ä»–ã‚’å…¨ã¦æŒ‡å®š (d:ã‚¨ãƒãƒƒã‚¯ã€e:ãƒ­ã‚¤ã‚¿ãƒ¼ã€f:å…±åŒã€g:æ¯æ—¥ã€h:æ—¥çµŒ)

      # å„ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚µã‚¤ãƒˆåˆ¥ã«ã€å®šæœŸè¦³æ¸¬ã‚¯ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã®ON/OFFã€ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã®ON/OFFæŒ‡å®šã‚’ç™»éŒ²ã™ã‚‹ã€‚
      #   stop_controller_update_flow.py
      #   a:ã‚¯ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚’OFFã€b:ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚’OFFã€C:ä½•ã‚‚ã—ãªã„ã€‚
      # 

      # å®šæœŸè¦³æ¸¬
      #   regular_observation_flow.py
      #     ç”£çµŒï¼šã‚¯ãƒ­ãƒ¼ãƒªãƒ³ã‚°ãƒ»ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ã€‚
      #     æœæ—¥ï¼šã‚¯ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã®ã¿ç¨¼åƒã€‚ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ã€‚
      #     èª­å£²ï¼šé€šå¸¸ç¨¼åƒã€‚
      # 
      # ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°
      #   manual_scrapying_flow.py
      # 
      # ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¯ãƒªãƒƒãƒ—ãƒã‚¹ã‚¿ãƒ¼ä¿å­˜
      #   manual_news_clip_master_save_flow.py
      # 
      # ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ¬ãƒãƒ¼ãƒˆ
      #   scraper_pattern_report_flow.py
      # 
      # Scrapyçµ±è¨ˆæƒ…å ±é›†è¨ˆ
      #   stats_info_collect_flow.py
      # Scrapyçµ±è¨ˆæƒ…å ±ãƒ¬ãƒãƒ¼ãƒˆ
      #   stats_analysis_report_flow.py
      # 
      # åŒæœŸãƒã‚§ãƒƒã‚¯
      #   crawl_sync_check_flow.py
      #   
      # mongoDBã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
      #   mongo_export_selector_flow.py
      # mongoDBå‰Šé™¤
      #   mongo_delete_selector_flow.py
      # mongoDBã‚¤ãƒ³ãƒãƒ¼ãƒˆ
      #   mongo_import_selector_flow.py
      # 
      # 
      # 
      # 
      # 
      # 
      # 
      # 