name: Docker Image Check & pull & recovery
run-name: Docker Image Check & pull & recovery-run
on: 
    # ä»¥ä¸‹ã®ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸéš›èµ·å‹•
    # push:
    #     branches: ["github-actions-test"]
    # Githubã‚ˆã‚Šæ‰‹å‹•ã§èµ·å‹•
    workflow_dispatch:

jobs:
  Docker-Image-Create:
    runs-on: ubuntu-22.04
    environment:
      name: TEST
    env:
        ## mongoDBç”¨ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã§å‚ç…§ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°
        MONGO_TAG: 7.0.1-jammy
        ## dockerfile_baseã§å‚ç…§ã™ã‚‹ubuntuã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°
        UBUNTU_TAG: 22.04
        ## # dockerfile_appã§å‚ç…§ã™ã‚‹baseã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°
        BASE_TAG: test-0.15
        # docker-composeã§å‚ç…§ã™ã‚‹appã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°
        APP_TAG: test-0.15
        # ã‚³ãƒ³ãƒ†ãƒŠãƒ¼å†…rootãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
        CONTAINER_ROOT_USER: root_user
        CONTAINER_ROOT_PASS: password
        # ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
        CONTAINER_USER: common_user
        CONTAINER_USER_PASS: password
        # ãƒ–ãƒ©ã‚¦ãƒ‹ãƒ¼å·¥æˆ¿ã®gitãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªãƒ¼
        GIT_REMOTE_REPOSITORY: https://github.com/pubranko/BrownieAtelierNewsCrawler.git
        # ä¸Šè¨˜ãƒªãƒã‚¸ãƒˆãƒªãƒ¼ã®gitãƒ–ãƒ©ãƒ³ãƒ
        GIT_BRANCH: github-actions-test
        # Firefox ã® gecko driver
        GECKO_DRIVER: https://github.com/mozilla/geckodriver/releases/download/v0.33.0/geckodriver-v0.33.0-linux64.tar.gz

        # ãƒ›ã‚¹ãƒˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰å´ã®mongoDBæ¥ç¶šç”¨ã®crtã‚„pemãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿ç®¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
        LOCAL_MONGO_KEY_DIR: /tmp

        # docker-compose commandé¸æŠ
        CONTAINER_START_COMMAND: /home/common_user/BrownieAtelierNewsCrawler/sh/github_actions_unit_test.sh

        # mongoDBã‚³ãƒ³ãƒ†ãƒŠãƒ¼ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã€mongoDBæ¥ç¶šæƒ…å ±
        BROWNIE_ATELIER_MONGO__MONGO_SERVER: mongo-server
        BROWNIE_ATELIER_MONGO__MONGO_PORT: 27017
        BROWNIE_ATELIER_MONGO__MONGO_USE_DB: test_crawler_db
        BROWNIE_ATELIER_MONGO__MONGO_USER: mongo_user
        BROWNIE_ATELIER_MONGO__MONGO_PASS: mongo_pass
        BROWNIE_ATELIER_MONGO__MONGO_TLS: false
        BROWNIE_ATELIER_MONGO__MONGO_TLS_CA_FILE: 
        BROWNIE_ATELIER_MONGO__MONGO_TLS_CERTTIFICATE_KEY_FILE: 
        # mongoDBã‚³ãƒ³ãƒ†ãƒŠãƒ¼rootæƒ…å ±
        BROWNIE_ATELIER_MONGO__MONGO_INITDB_ROOT_USERNAME: root_user
        BROWNIE_ATELIER_MONGO__MONGO_INITDB_ROOT_PASSWORD: password
        # Emailæ¥ç¶šæƒ…å ±
        BROWNIE_ATELIER_NOTICE__SMTP_HOST: ${{ secrets.BROWNIE_ATELIER_NOTICE__SMTP_HOST }}
        BROWNIE_ATELIER_NOTICE__SMTP_PORT: ${{ secrets.BROWNIE_ATELIER_NOTICE__SMTP_PORT }}
        BROWNIE_ATELIER_NOTICE__FROM_EMAIL: ${{ secrets.BROWNIE_ATELIER_NOTICE__FROM_EMAIL }}
        BROWNIE_ATELIER_NOTICE__TO_EMAIL: ${{ secrets.BROWNIE_ATELIER_NOTICE__TO_EMAIL }}
        BROWNIE_ATELIER_NOTICE__PASSWORD: ${{ secrets.BROWNIE_ATELIER_NOTICE__PASSWORD }}

        # dummy
        HOST_OS_IP_ADDRESS: 192.0.0.1
        # dummy
        PREFECT_HOME: /home/root_user/BrownieAtelierNewsCrawler
        PREFECT_API_URL: 
        PREFECT__API_KEY: 
        PREFECT__WORK_SPACE: 
        PREFECT__WORK_POOL: 
        SCRAPY__LOG_LEVEL: INFO

        # Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã® tar ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‡ºåŠ›å…ˆã®ãƒ‘ã‚¹
        PATH_CACHE: /tmp/docker-img-arch

        # ãƒ¯ãƒ¼ã‚¯
        IMAGE_EXISTS:
    steps:
      - run: echo "ğŸ‰ èµ·å‹•ã‚¤ãƒ™ãƒ³ãƒˆã®ç¨®é¡ (${{ github.event_name }})"
      - run: echo "ğŸ§ githubä¸Šã®OSã®ç¨®é¡ (${{ runner.os }})"
      - name: ãƒªãƒã‚¸ãƒˆãƒª(${{ github.repository }})ãƒ»ãƒ–ãƒ©ãƒ³ãƒ(${{ github.ref }})ã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        # ä¸Šè¨˜ã®ãƒªãƒã‚¸ãƒˆãƒªãƒ»ãƒ–ãƒ©ãƒ³ãƒã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      # - name: baseã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’pull
      #   run: |
      #     docker pull mikuras/brownie_atelier_news_crawler_base:$BASE_TAG
      #     docker images

      - name: baseã‚¤ãƒ¡ãƒ¼ã‚¸å­˜åœ¨ãƒã‚§ãƒƒã‚¯
        id: check-image
        # run: |
        #   IMAGE_EXISTS=$(docker images -q mikuras/brownie_atelier_news_crawler_base:$BASE_TAG)
        #   echo "::set-output name=image_exists::$IMAGE_EXISTS"
        run: |
          echo $IMAGE_EXISTS
          docker images
          docker images --quiet mikuras/brownie_atelier_news_crawler_base:test-0.15
          BBB=$(docker images --quiet mikuras/brownie_atelier_news_crawler_base:test-0.15)
          echo 'IMAGE_EXISTS=$BBB' >> $GITHUB_ENV
          echo $BBB
          echo ${{env.IMAGE_EXISTS}}
          echo $GITHUB_ENV
  
      - name: baseã‚¤ãƒ¡ãƒ¼ã‚¸ãŒæ—¢ã«docker hubã«ç™»éŒ²ã•ã‚Œã¦ã„ãŸå ´åˆã€pullã‚’å®Ÿè¡Œ
        # if: steps.check-image.outputs.image_exists
        if: startsWith(!'${{env.IMAGE_EXISTS}}','')
        run: |
          echo IMAGE_EXISTS
          echo $IMAGE_EXISTS
          docker pull mikuras/brownie_atelier_news_crawler_base:$BASE_TAG
          docker images
      
      - name: baseã‚¤ãƒ¡ãƒ¼ã‚¸ãŒãªã„å ´åˆã€baseã‚¤ãƒ¡ãƒ¼ã‚¸ç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å®šç¾© & å¾©å…ƒ
        # if: steps.check-image.outputs.image_exists == 'false'
        if: startsWith('${{env.IMAGE_EXISTS}}','')
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ID ã®å®šç¾©
        id: base_image_cache
        uses: actions/cache@v4
        with:
          path: ${{ env.PATH_CACHE }}
          key: ${{ runner.os }}-brownie_atelier_news_crawler_base-${{ env.BASE_TAG }}

      # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚‹å ´åˆã¯ tar ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸ä¸€è¦§ã«è¿½åŠ 
      - name: docker hubã«baseã‚¤ãƒ¡ãƒ¼ã‚¸ãŒãªãã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚‹å ´åˆã¯ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚ˆã‚Šã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ­ãƒ¼ãƒ‰
        if: steps.base_image_cache.outputs.cache-hit == 'true'
        run: |
          ls -l ${{ env.PATH_CACHE }}
          docker load --input ${{ env.PATH_CACHE }}/${{ runner.os }}-brownie_atelier_news_crawler_base-${{ env.BASE_TAG }}.tar
          docker images
